var ostanCsvUrl="csv/unemployment94_locid.csv";var ostanTopoUrl="topo/piran-amarcoded-zeropadID-.json.txt";var locIdFieldInCsv="locid";var timeFieldInCsv="yearseason";var locNameFieldInCsv="region";var attributeArray=[];var _csvData=[];var _provData=[];var _oosData=[];var topoData=[];var curOstanStyleSaved="";var csvData=[];var mapData=[];var _ostanCsvData=[];var _ostanTopoData=[];var curLocID="23";var curTime=13941;var svg;var tooltip=d3.select("#main").append("div").attr("class","hidden tooltip");var tooltip2=d3.select("#lineChart").append("div").attr("class","hidden tooltip");queue().defer(d3.csv,ostanCsvUrl).defer(d3.json,ostanTopoUrl).await(DataReady);function DataReady(a,b,c){if(a){throw a}_ostanCsvData=b;_ostanCsvData.forEach(function(e){e.yearseason=e.year+""+e.season});_ostanTopoData=c;subsetChanged(true)}function filterData(){var a=[];topoData=_ostanTopoData;csvData=_ostanCsvData;locNameFieldInCsv="region"}function drawMap(g){var d=1000,h=600;var e=d3.geo.mercator().center([51,32]).scale(2000).translate([350,h/2+25]).precision(0);var i=d3.geo.path().projection(e);var f=function(j){return i(j).replace(/(\.\d{1})\d+/g,"$1")};var b=d3.map();var c=d3.scale.quantize().domain([100,4000]).range(d3.range(11).map(function(j){return"q"+j+"-11"}));d3.selectAll("#main svg").attr("class","hidden");ssvg=d3.select("#main loctype");if(!ssvg.empty()){ssvg.attr("class","nothidden");return}svg=d3.select("#main").append("svg").attr("width",d).attr("height",h).attr("id","loctype").attr("class","nothidden");var a=topojson.feature(g,g.objects["iran-amarcoded"]);svg.append("g").attr("class","provinces").selectAll("path").data(a.features).enter().append("path").attr("d",f).attr("class","province").attr("locid",function(j){return j.id}).attr("toponame",function(j){return j.properties.name}).attr("pername",function(j){return j.properties.name}).on("mousemove",function(m){var j=d3.mouse(svg.node()).map(function(n){return parseInt(n)});var k=getRadioVal("valueSelector");tooltip.classed("hidden",false).style("left",j[0]+800).style("top",j[1]+50).html(this.getAttribute("toponame")+"<br>"+numberWithCommas(Math.trunc(this.getAttribute("pop")))+"%")}).on("mouseout",function(){tooltip.classed("hidden",true)}).on("click",function(j){selectLocation(j.id)});timeChange(curTime)}function activateCurOstan(a){oldOstans=d3.select(".nothidden path.selected");if(!oldOstans.empty()){oldOstans.classed("selected",false)}curOstan=d3.select(".nothidden [locid='"+a+"']");curOstanStyle=curOstan.attr("style");curOstan.classed("selected",true)}function getSeasonName(b){var a=["بهار","تابستان","پاییز","زمستان"];return a[b-1]}function formatTime(a){return Math.trunc(a/10).toString()+"-"+getSeasonName(a%10)}function drawLineCharts(){var e={top:10,right:20,bottom:10,left:20};var b=600-e.right-e.left,h=600-e.top-e.bottom;var g=d3.scale.ordinal().rangeRoundBands([0,b]);var f=d3.scale.linear().range([h,0]);var c=d3.svg.axis().scale(g).orient("bottom").tickFormat(formatTime).tickPadding(5);var a=d3.svg.axis().scale(f).orient("left");var i=d3.svg.line().x(function(j){return g(+j[timeFieldInCsv])+g.rangeBand()/2}).y(function(j){return f(+j[aggregateField])});color=d3.scale.ordinal().domain(["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","99"]).range(["red","maroon","yellow","olive","lime","green","aqua","teal","blue","navy","fuchsia","purple","salmon","crimson","khaki","forestgreen","darkgreen","pink","deeppink","silver","dimgray","gold","plum","palegreen","skyblue","rosybrown","chocolate","azure","linen","deepskyblue","peachpuff","black"]);aggregateField=getRadioVal("valueSelector");selectedLocs=["99"];d3.selectAll("path.selected").each(function(){selectedLocs.push(this.getAttribute("locid"))});selectedLocs.sort(function(k,j){return +k-j});lineData=_ostanCsvData.filter(function(j){return selectedLocs.indexOf(j[locIdFieldInCsv])>=0});g.domain(lineData.map(function(j){return +j[timeFieldInCsv]}));f.domain(d3.extent(lineData,function(j){return +j[aggregateField]}));div=d3.selectAll("#lineChart");div.attr("width",b+e.left+e.right).attr("height",h+e.top+e.bottom);svg=div.select("svg");if(svg.empty()){svg=div.append("svg").attr("width",b+e.left+e.right).attr("height",h+e.top+e.bottom)}chart=svg.select("g");if(chart.empty()){chart=svg.append("g").attr("transform","translate("+e.left+", "+e.top+")")}var d=chart.selectAll("g.x.axis").data([1]);d.enter().append("g").attr("class","x axis").attr("transform","translate(0,"+(h-20).toString()+")").append("text");d.call(c);persianField=aggregateField=="unemployment_rate"?"نرخ بیکاری":"نرخ مشارکت اقتصادی";d=chart.selectAll("g.y.axis").data([1]);d.enter().append("g").attr("class","y axis").attr("transform","translate(15, 0)").append("text").attr("class","axistitle").attr("transform","rotate(-90)").attr("y",6).attr("dy","1em").style("text-anchor","end");d.selectAll(".axistitle").text(persianField);d.transition().duration(750).call(a);ostan=chart.selectAll(".ostan").data(selectedLocs,function(k,j){return +k});ostan.exit().remove();newostans=ostan.enter();newostans.append("g").attr("class","ostan").append("path").attr("class","line").style("stroke",color).on("click",function(j){locid=this.__data__;selectLocation(locid)});ostan.transition().duration(750).selectAll(".line").style("stroke",color).attr("d",function(j){data=lineData.filter(function(k){return k[locIdFieldInCsv]==j});return i(data)});l=chart.selectAll("g.legend").data([1]).enter().append("g").attr("class","legend").attr("transform","translate("+(b-50).toString()+", 0)");legend=chart.select("g.legend").selectAll("circle.legenditem").data(selectedLocs,function(k,j){return +k});legend.exit().remove();legend.enter().append("circle").attr("class","legenditem");legend.style("fill",color);legend.transition().duration(750).attr("cx",0).attr("cy",function(k,j){data=lineData.filter(function(m){return m[locIdFieldInCsv]==k});data.sort(function(n,m){return n[timeFieldInCsv]-m[timeFieldInCsv]});return +f(data[data.length-1][aggregateField])}).attr("r",3);legendtext=chart.select("g.legend").selectAll("text.legenditem").data(selectedLocs,function(k,j){return +k});legendtext.exit().remove();legendtext.enter().append("text").attr("class","legenditem");legendtext.style("fill",color);legendtext.transition().duration(750).attr("x",10).attr("y",function(k,j){data=lineData.filter(function(m){return m[locIdFieldInCsv]==k});data.sort(function(n,m){return n[timeFieldInCsv]-m[timeFieldInCsv]});return +f(data[data.length-1][aggregateField])}).text(function(j){return lineData.find(function(k){return k[locIdFieldInCsv]==j}).region});chart.selectAll("rect.timebar").data([1]).enter().append("rect").attr("class","timebar");timebar=chart.selectAll("rect.timebar");timebar.attr("width",g.rangeBand()/2).attr("y",0).attr("height",h);timebar.transition().duration(750).attr("x",g(curTime)+g.rangeBand()/4);allCircles=chart.selectAll("g.circles").data([1]).enter().append("g").attr("class","circles");circ=chart.select("g.circles").selectAll("circle.dataPoint").data(lineData,function(j){return"{locid:"+j[locIdFieldInCsv]+",time:"+j[timeFieldInCsv]+"}"});circ.exit().remove();circ.enter().append("circle").attr("class","dataPoint").attr("r",6).style("z-index",9998).style("fill","white").style("stroke-width","3px").style("stroke",function(j){return color(j[locIdFieldInCsv])}).on("mousemove",function(m){var j=d3.mouse(chart.node()).map(function(n){return parseInt(n)});var k=getRadioVal("valueSelector");tooltip2.classed("hidden",false).style("left",j[0]+0).style("top",j[1]+50).html(m[locNameFieldInCsv]+"<br>"+formatTime(m[timeFieldInCsv])+"<br>"+numberWithCommas(Math.trunc(m[k]))+"%")}).on("mouseout",function(){tooltip2.classed("hidden",true)});circ.transition().duration(750).attr("cx",function(j){return +g(j[timeFieldInCsv])+g.rangeBand()/2}).attr("cy",function(j){return +f(j[aggregateField])});currentTimeData=lineData.filter(function(j){return j[timeFieldInCsv]==curTime});circles=chart.selectAll("g.circles").data([1]).enter().append("g").attr("class","circles");circ=chart.select("g.circles").selectAll("circle.curTime").data(currentTimeData,function(k,j){return k[locIdFieldInCsv]});circ.exit().remove();circ.enter().append("circle").attr("class","curTime").attr("r",7).style("z-index",9999).style("fill",function(j){return color(j[locIdFieldInCsv])}).on("mousemove",function(m){var j=d3.mouse(chart.node()).map(function(n){return parseInt(n)});var k=getRadioVal("valueSelector");tooltip2.classed("hidden",false).style("left",j[0]+0).style("top",j[1]+50).html(m[locNameFieldInCsv]+"<br>"+formatTime(m[timeFieldInCsv])+"<br>"+numberWithCommas(Math.trunc(m[k]))+"%")}).on("mouseout",function(){tooltip2.classed("hidden",true)});circ.transition().duration(750).attr("cx",function(j){return +g(j[timeFieldInCsv])+g.rangeBand()/2}).attr("cy",function(j){return +f(j[aggregateField])})}function drawBarChartLocComparison(d){var j=[];var q=0;var b="";var t="";if(d.length>2){b=d.substr(0,2);j=csvData.filter(function(u){return u[locIdFieldInCsv].substr(0,2)==b});q=1;t="استان "+d3.select('[locid="'+d.substr(0,2)+'"]').attr("toponame")}else{b="iran";j=csvData;q=0;t="کل کشور"}var k={top:10,right:50,bottom:50,left:50},r=600-k.left-k.right,m=230-k.top-k.bottom;var g=d3.scale.ordinal().rangeRoundBands([0,r],0.3);var f=d3.scale.linear().rangeRound([m,0]);var a=d3.svg.axis().scale(f).orient("left");var e=d3.svg.axis().scale(g).ticks(0).orient("bottom");var s=d3.select("#locCompare").selectAll(".barTitle").data([1]);s.enter().append("div");s.attr("class","barTitle").text(t);var n=d3.select("#ostansvg");if(n.attr("locid")!=b){n.selectAll("rect").remove()}n.attr("width",r+k.left+k.right).attr("height",m+k.top+k.bottom).attr("locid",b);n=n.selectAll("g").data([1]);n.enter().append("g").attr("transform","translate("+k.left+","+k.top+")");var i=getRadioVal("valueSelector");var h=i.replace("percent.","");var p=d3.nest().key(function(u){return q==1?u[locIdFieldInCsv].substr(2,2):u[locIdFieldInCsv]}).rollup(function(u){if(i.startsWith("percent")){return Math.trunc(100*d3.sum(u,function(v){return v[h]})/d3.sum(u,function(v){return v["population.total"]}))}else{return d3.sum(u,function(v){return v[h]})}}).entries(j);p.forEach(function(u){u.loc=u.key;if(q==0){u.name=j.find(function(v){return v[locIdFieldInCsv]==u.key})[locNameFieldInCsv];u.selected=u.loc==d}else{u.name=j.find(function(v){return v[locIdFieldInCsv].substr(2,2)==u.key})[locNameFieldInCsv];u.selected=(b+u.loc)==d}u.pop=u.values});p.sort(function(v,u){return u.pop-v.pop});g.domain(p.map(function(u){return u.name}));f.domain([0,1.2*d3.max(p,function(u){return u.pop})]);var c=n.selectAll("g.x.axis").data([1]);c.enter().append("g").attr("class","x axis").attr("transform","translate(0, "+(m+20)+")").call(e).selectAll("text").style("text-anchor","middle").attr("dy",".35em");c.call(e).selectAll("text").attr("transform",function(u){return"rotate(-90,"+this.getAttribute("x")+","+this.getAttribute("y")+") translate(25, 0)"}).style("text-anchor","end");c.selectAll("line").remove();c=n.selectAll("g.y.axis").data([1]);c.enter().append("g").attr("class","y axis").selectAll("text").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Population");c.call(a);var o=n.selectAll(".bar").data(p,function(u){return u.loc});o.enter().append("rect").classed("bar",true).attr("y",m).attr("height",0).attr("x",function(u){return g(u.name)}).attr("width",g.rangeBand()).attr("loc",function(u){return u.loc}).attr("locname",function(u){return u.name}).on("click",function(v){var u=this.getAttribute("loc");if(q==1){u=b+u}selectLocation(u)}).on("mousemove",function(w){var v=getRadioVal("valueSelector");var u=v.startsWith("percent")?"درصد":"نفر";tooltip2.classed("hidden",false).style("left",d3.event.pageX+15).style("top",d3.event.pageY-35).html(this.getAttribute("locname")+"<br>"+numberWithCommas(this.getAttribute("pop"))+" "+u)}).on("mouseout",function(){tooltip2.classed("hidden",true)});o.classed("selected",function(u){return u.selected}).attr("style",function(u){return q==0?d3.select("[locid='"+u.loc+"']").attr("style"):d3.select("[locid='"+b+u.loc+"']").attr("style")}).attr("pop",function(u){return u.pop});o.transition().duration(750).attr("y",function(u){return f(u.pop)}).attr("height",function(u){return m-f(u.pop)}).attr("x",function(u){return g(u.name)})}function timeChange(e){var d=getRadioVal("valueSelector");var b=d=="unemployment_rate"?"Beige":"Azure";var f=d=="unemployment_rate"?"#DD0000":"SeaGreen";var c=d3.interpolateRgb(b,f);var d=getRadioVal("valueSelector");unempData=csvData.filter(function(g){return g[timeFieldInCsv]==e});var a=d3.scale.linear().range([0,1]).domain([d3.min(unempData,function(g){return +g[d]}),d3.max(unempData,function(g){return +g[d]})]);d3.selectAll("path.province").attr("style",function(g){provData=unempData.find(function(h){return h[locIdFieldInCsv]==g.id});if(provData){col=c(a(provData[d]));return"fill: "+col}else{return""}}).attr("pop",function(g){provData=unempData.find(function(h){return h[locIdFieldInCsv]==g.id});if(provData&&provData[d]){return Math.round(provData[d]*100)/100}else{return"N/A"}});curTime=e;document.getElementById("timeSliderText").innerHTML=formatTime(curTime);drawLineCharts()}function drawBarCharts(a){activateCurOstan(a);drawLineChartLocComparison()}function selectLocation(a){toggleSelection(a);drawLineCharts()}function toggleSelection(a){curOstan=d3.select("path[locid='"+a+"']");if(!curOstan.empty()){curOstan.classed("selected",!curOstan.classed("selected"))}}function numberWithCommas(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function subsetChanged(a){filterData();if(a){drawMap(topoData);curLocID="23"}timeChange(curTime)}function repValueChanged(){}function getRadioVal(b){var d;var e=document.getElementsByName(b);for(var a=0,c=e.length;a<c;a++){if(e[a].checked){d=e[a].value;break}}return d}function getSelectValues(c){var b=[];var d=c&&c.options;var f;for(var e=0,a=d.length;e<a;e++){f=d[e];if(f.selected){b.push(f.value||f.text)}}return b}function getSelectValues_(b){var a=[];items=d3.selectAll(b+" li input");items.each(function(c){if(this.checked){a.push(this.value||this.text)}});return a};